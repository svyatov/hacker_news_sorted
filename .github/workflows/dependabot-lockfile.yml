name: Dependabot Lockfile Fix

on: pull_request_target

permissions:
  contents: write

jobs:
  fix-lockfile:
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    steps:
      - uses: actions/checkout@v4

      - name: Get package.json from PR
        env:
          GH_TOKEN: ${{ github.token }}
          PR_HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: gh api "repos/${GITHUB_REPOSITORY}/contents/package.json?ref=${PR_HEAD_SHA}" --jq '.content' | base64 --decode > package.json

      - uses: oven-sh/setup-bun@v2

      - run: bun install --no-save

      - name: Push lockfile to PR branch
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const content = fs.readFileSync('bun.lock').toString('base64');
            const branch = context.payload.pull_request.head.ref;

            let sha;
            try {
              const { data } = await github.rest.repos.getContent({
                ...context.repo,
                path: 'bun.lock',
                ref: branch,
              });
              sha = data.sha;
              if (data.content.replace(/\n/g, '') === content) {
                console.log('Lockfile already up to date');
                return;
              }
            } catch {
              // bun.lock doesn't exist on PR branch yet
            }

            await github.rest.repos.createOrUpdateFileContents({
              ...context.repo,
              path: 'bun.lock',
              message: 'chore: update bun.lock',
              content,
              sha,
              branch,
            });
            console.log('Lockfile updated on PR branch');
